# OS course design

[TOC]

## Lab: Xv6 and Unix utilities

本实验的主要目的是熟悉xv6以及其系统调用。



### 1. Boot xv6 (easy）

#### 1） 实验目的

获取实验室的xv6源代码并切换到`util`分支，构建并运行xv6。

#### 2） 实验步骤

1.  将`xv6-labs-2021`克隆至本地，创建并切换至`util`分支：

   ```bash
   $ git clone git://g.csail.mit.edu/xv6-labs-2021
   Cloning into 'xv6-labs-2021'...
   ...
   $ cd xv6-labs-2021
   $ git checkout util
   ```

2.  构建并运行xv6：

   ```bash
   $ make qemu
   ```

#### 3） 实验中遇到的问题和解决方法

无。

#### 4） 实验心得

1. 学会了如何切换分支。
2. 学会了使用`qemu`运行xv6环境。



### 2. sleep (easy）

#### 1）实验目的

实现xv6的UNIX程序`sleep`：暂停用户指定的计时数。

#### 2） 实验步骤

1. 在user目录下创建`sleep.c`。

2. 在`sleep.c`中编写程序实现功能：

   - 获取用户提供的参数作为暂停的时钟周期数。
   - 使用`sleep()`系统调用暂停相应的周期数。

3. 在Makefile文件的UPROGS中添加$U/_sleep\。

4. 运行xv6并测试sleep命令：

   ```bash
   $ make qemu
   ...
   init: starting sh
   $ sleep 10
   (nothing happens for a little while)
   $
   ```

5. 测试程序得分：

   ```bash
   $ ./grade-lab-util sleep
   ```

   或是

   ```bash
   $ make GRADEFLAGS=sleep grade
   ```

#### 3） 实验中遇到的问题与解决方法

**问题1**：

不了解如何获取用户输入的参数。

**解决方法**：

通过查询互联网资料了解了`main`函数的两个参数`argc`、`argv`的含义。

> argc：表示运行程序的时候给`main`函数传递了几个参数。
>
> argv：用来存储`argc`个字符串，每个字符串就是给`main`函数传的一个参数。

#### 4） 实验心得

1. 学会了如何处理命令行参数。
2. 学会了`sleep`系统调用的使用方法。



### 3. pingpong （easy）

#### 1）实验目的

实现xv6的UNIX程序`pingpong`：在两个进程间通过一对管道来传递数据。

#### 2） 实验步骤

1. 在user目录下创建`pingpong.c`。

2. 在`pingpong.c`中编写程序实现功能：

   - 使用`pipe()`系统调用创建一对管道`p2c`和`c2p`用来在两个进程间传递数据。
   - 使用`fork()`系统调用创建子进程。
   - 父进程：
     - 使用`close()`系统调用，关闭子进程向父进程的读和写。
     - 使用`write()`系统调用，向管道`p2c`中写入数据。
     - 使用`read()`系统调用，从管道`c2p`中读取数据并打印信息。
     - 使用`wait()`系统调用，等待子进程结束。
   - 子进程：
     - 使用`close()`系统调用，关闭父进程向子进程的读和写。
     - 使用`read()`系统调用，从管道`p2c`中读取数据并打印信息。
     - 使用`write()`系统调用，向管道`c2p`中写入数据。

3. 在Makefile文件的UPROGS中添加$U/_pingopng\。

4. 运行xv6并测试sleep命令：

   ```bash
   $ make qemu
   ...
   init: starting sh
   $ pingpong
   4: received ping
   3: received pong
   $
   ```

5. 测试程序得分：

   ```bash
   $ ./grade-lab-util pingpong
   ```

   或是

   ```bash
   $ make GRADEFLAGS=pingpong grade
   ```

#### 3） 实验中遇到的问题与解决方法

**问题1：**

不知道什么时候应该关闭管道相应的读写。

**解决方法：**

通过查询网络资料，得知何时应关闭管道。

> 当完成对文件的读取或写入操作后，应该关闭文件。这有助于释放系统资源。

#### 4） 实验心得

1. 学会了如何使用`pipe()`、`fork()`、`close()`、`write()`、`read()`等系统调用。
2. 简单了解了父子进程间的通信。



### 4. primes （moderate）/（hard）

#### 1）实验目的

实现简易版的xv6的UNIX程序`primes`：寻找小于等于35的所有素数

#### 2） 实验步骤

1. 在user目录下创建`primes.c`。

2. 在`primed.c`中编写程序实现功能：

   - 使用`pipe()`系统调用，创建管道用来通信。
   - 将0-35写入管道中。
   - 使用`fork()`系统调用创建子进程。
   - 父进程：
     - 使用`close()`系统调用，关闭读和写。
     - 使用`wait()`系统调用，等待子进程结束。
   - 子进程：
     - 使用`close()`系统调用，关闭左侧的写。
     - 使用`read()`系统调用，从左侧管道读取数据并打印信息。
     - 使用`pipe()`系统调用，创建右侧管道。
     - 筛选掉左侧第一个数的倍数。
     - 使用`write()`系统调用，向右侧管道中写入剩余的数据。
   - 循环创建子进程，直至左侧没有数据。

3. 在Makefile文件的UPROGS中添加$U/_primes\。

4. 运行xv6并测试primes命令：

   ```bash
   $ make qemu
   ...
   init: starting sh
   $ primes
   prime 2
   prime 3
   prime 5
   prime 7
   prime 11
   prime 13
   prime 17
   prime 19
   prime 23
   prime 29
   prime 31
   $
   ```

5. 测试程序得分：

   ```bash
   $ ./grade-lab-util primes
   ```

   或是

   ```bash
   $ make GRADEFLAGS=primes grade
   ```

#### 3） 实验中遇到的问题与解决方法

**问题1：**

不知道该怎样利用创建子进程来实现循环。

**解决方法：**

通过查询网络资料解决了该问题。

> 在子进程调用的函数中再次使用`fork()`函数创建新的子进程。

#### 4） 实验心得

1. 学会了如何通过创建子进程来实现循环。
2. 掌握了一种新的求素数的算法。



### 5. find （moderate）

#### 1）实验目的

实现xv6的UNIX程序`find`：用户指定目录与文件名，寻找该目录下的所有的该文件名的文件。

#### 2） 实验步骤

1. 在user目录下创建`find.c`。

2. 在`find.c`中编写程序实现功能：

   - 获取用户输入的参数作为目录名与文件名。
   - 使用`open()`和`fstat()`系统调用，打开目录并获取信息。
   - 使用`read()`系统调用，读取该目录下所有的目录与文件。
   - 文件：
     - 判断文件名与指定文件名是否相同。
   - 目录：
     - 递归查询。
   - 循环上述步骤直至读取完毕。

3. 在Makefile文件的UPROGS中添加$U/_find\。

4. 运行xv6并测试find命令：

   ```bash
   $ make qemu
   ...
   init: starting sh
   $ echo > b
   $ mkdir a
   $ echo > a/b
   $ find . b
   ./b
   ./a/b
   $ 
   ```

5. 测试程序得分：

   ```bash
   $ ./grade-lab-util find
   ```

   或是

   ```bash
   $ make GRADEFLAGS=find grade
   ```

#### 3） 实验中遇到的问题与解决方法

**问题1：**

不知道如何对文件进行处理。

**解决方法：**

通过查看xv6资料中的其他程序的代码，解决了该问题。

> 通过`open()`和`fstat()`系统调用来打开文件并获取文件信息。

#### 4） 实验心得

1. 学会了如何使用open()和fstat()系统调用来对文件进行操作。



### 6. xargs （moderate）

#### 1）实验目的

实现xv6的UNIX程序`xargs`：获取标准输入，并将输入作为命令的参数。

#### 2） 实验步骤

1. 在user目录下创建`xargs.c`。

2. 在`xargs.c`中编写程序实现功能：

   - 获取用户输入的参数作为将要执行的命令。
   - 使用`read()`系统调用，从标准输入中获取数据。
   - 每次读取一个数据，遇到换行符时，使用`exec()`系统调用，执行新的程序。

3. 在Makefile文件的UPROGS中添加$U/_xargs\。

4. 运行xv6并测试xargs命令：

   ```bash
   $ make qemu
   ...
   init: starting sh
   $ sh < xargstest.sh
   $ $ $ $ $ $ hello
   hello
   hello
   $ $
   ```

5. 测试程序得分：

   ```bash
   $ ./grade-lab-util xargs
   ```

   或是

   ```bash
   $ make GRADEFLAGS=xargs grade
   ```

#### 3） 实验中遇到的问题与解决方法

无

#### 4） 实验心得

1. 学会了`exec()`系统调用的使用方法。

